<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZINGA SITE</title>
    
    <!-- Meta and Favicon Links -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <meta name="title" content="GN-Math">
    <meta name="description" content="Play unblocked games on BAZINGA SITE. Fast, free, no downloads—perfect for school or home.">
    <meta property="og:title" content="BAZINGA SITE">
    <meta property="og:description" content="Play unblocked games on BAZINGA SITE. Fast, free, no downloads—perfect for school or home.">
    
    <!-- External Scripts -->
    <script>
        window.addEventListener('beforeunload', function (event) { event.preventDefault(); event.returnValue = ''; return 'Are you sure you want to leave?'; });
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5521219086088837" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX5VS54ZDW"></script>
    <meta name="google-adsense-account" content="ca-pub-5521219086088837">
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-WX5VS54ZDW');
    </script>
    
    <style>
        :root {
            --primary: #fc2651; --primary-hover: #e91e47; --primary-light: rgba(252, 38, 81, 0.1);
            --text: #1a1a1a; --text-muted: #6b7280; --bg: #ffffff; --bg-secondary: #f8fafc;
            --surface: #ffffff; --surface-hover: #f1f5f9; --border: #e2e8f0; --glass: rgba(255, 255, 255, 0.8);
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 12px; --radius-lg: 16px;
            --gradient-primary: linear-gradient(135deg, #fc2651 0%, #e91e47 100%);
            --gradient-surface: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        .dark-mode {
            --primary: #fc2651; --primary-hover: #ff4d75; --primary-light: rgba(252, 38, 81, 0.15);
            --text: #f1f5f9; --text-muted: #94a3b8; --bg: #0f172a; --bg-secondary: #1e293b;
            --surface: #1e293b; --surface-hover: #334155; --border: #334155; --glass: rgba(30, 41, 59, 0.8);
            --gradient-surface: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif; line-height: 1.6; margin: 0; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
        header { background: var(--gradient-primary); color: white; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-lg); backdrop-filter: blur(20px); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 1.25rem 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1.5rem; }
        .logo { font-size: 1.75rem; font-weight: 800; }
        .search-container { display: flex; flex: 1; max-width: 500px; gap: 0.75rem; }
        #searchBar, #sortOptions { padding: 0.875rem 1rem; border: 0; border-radius: var(--radius); background: var(--glass); backdrop-filter: blur(20px); color: var(--text); font-size: 15px; outline: none; box-shadow: var(--shadow-sm); }
        main { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        #container, #featuredZones { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .zone-item { background: var(--gradient-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: var(--shadow-sm); }
        .zone-item:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-xl); border-color: var(--primary); }
        .zone-item img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; background: var(--border-light); }
        .zone-item button { background: transparent; color: var(--text); border: 0; padding: 1.25rem 1rem; cursor: pointer; font-weight: 600; font-size: 14px; min-height: 70px; display: flex; align-items: center; justify-content: center; }
        .zone-item:hover button { color: var(--primary); background: rgba(252, 38, 81, 0.05); }
        #zoneViewer { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        .zone-header { background: var(--gradient-primary); color: white; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
        #zoneName { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .zone-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .zone-controls button { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 0.625rem 1rem; border-radius: var(--radius); cursor: pointer; font-weight: 600; }
        #zoneFrame { flex-grow: 1; border: none; }
        footer { background: var(--bg-secondary); border-top: 1px solid var(--border); padding: 2rem 1rem; margin-top: 3rem; text-align: center; }
        .footer-links { display: flex; justify-content: center; gap: 2rem; }
        .footer-links a { color: var(--primary); text-decoration: none; font-weight: 600; }
        @media (max-width: 768px) { .header-content { flex-direction: column; } #container, #featuredZones { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); } }
    </style>
</head>
<body class="dark-mode">
    <header>
        <div class="header-content">
            <div class="logo">BAZINGA SITE</div>
            <div class="search-container">
                <input type="text" id="searchBar" placeholder="Search for a game...">
                <select id="sortOptions">
                    <option value="name">Name</option>
                    <option value="popular">Popular</option>
                    <option value="id">ID (Date)</option>
                </select>
            </div>
        </div>
    </header>

    <main>
        <details id="featuredZonesWrapper" open>
            <summary id="featuredSummary" style="font-size: 1.2rem; font-weight: bold; cursor: pointer;">Featured Zones</summary>
            <div id="featuredZones"></div>
        </details>
        <br><hr><br>
        <details id="allZonesWrapper" open>
            <summary id="allSummary" style="font-size: 1.2rem; font-weight: bold; cursor: pointer;">All Zones</summary>
            <div id="container">Loading games...</div>
        </details>
    </main>

    <div id="zoneViewer">
        <div class="zone-header">
            <div>
                <h2 id="zoneName"></h2>
                <span id="zoneId" style="display: none;"></span>
                <a id="zoneAuthor" href="#" target="_blank" rel="noopener"></a>
            </div>
            <div class="zone-controls">
                <button onclick="fullscreenZone()">Fullscreen</button>
                <button onclick="aboutBlank()">Open in New Tab</button>
                <button onclick="downloadZone()">Download</button>
                <button onclick="closeZone()">Close</button>
            </div>
        </div>
        <iframe id="zoneFrame" allowfullscreen></iframe>
    </div>
    
    <footer>
        <div class="footer-links">
            <!-- Footer links can be added here -->
        </div>
    </footer>

    <script>
        const container = document.getElementById('container');
        const featuredContainer = document.getElementById('featuredZones');
        const zoneViewer = document.getElementById('zoneViewer');
        let zoneFrame = document.getElementById('zoneFrame');
        const searchBar = document.getElementById('searchBar');
        const sortOptions = document.getElementById('sortOptions');

        const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
        const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
        
        let allZones = [];
        let popularityData = {};

        async function listZones() {
            try {
                const newZonesUrl = "https://raw.githubusercontent.com/goaded/bazinga/main/jsonGames";

                const [oldResponse, newResponse] = await Promise.all([
                    fetch(oldZonesUrl).catch(e => console.error("Failed to fetch old zones:", e)),
                    fetch(newZonesUrl).catch(e => console.error("Failed to fetch new zones:", e))
                ]);

                const oldZones = oldResponse?.ok ? await oldResponse.json() : [];
                const newZones = newResponse?.ok ? await newResponse.json() : [];

                const combinedMap = new Map();

                // FIX: Prioritize Lower IDs by processing old zones first.
                oldZones.forEach(zone => {
                    const cleanName = zone.name.trim().toLowerCase();
                    combinedMap.set(cleanName, zone);
                });

                // Then, add new zones, but ONLY if a game with the same name doesn't already exist.
                // This ensures the lower-ID (old) version is kept in case of a name collision.
                newZones.forEach(zone => {
                    const cleanName = (zone.name.endsWith(':') ? zone.name.slice(0, -1) : zone.name).trim().toLowerCase();
                    if (!combinedMap.has(cleanName)) {
                        combinedMap.set(cleanName, zone);
                    }
                });

                allZones = Array.from(combinedMap.values());
                
                await fetchPopularity();
                sortZones();
                
                const searchParams = new URLSearchParams(window.location.search);
                const id = searchParams.get('id');
                if (id) {
                    const zone = allZones.find(z => z.id.toString() === id);
                    if (zone) openZone(zone);
                }
            } catch (error) {
                console.error("Error loading zone lists:", error);
                container.innerHTML = `Error loading games. Please try again later.`;
            }
        }

        async function fetchPopularity() {
            try {
                const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
                const data = await response.json();
                data.forEach(file => {
                    const idMatch = file.name.match(/\/(\d+)\.html$/);
                    if (idMatch) popularityData[parseInt(idMatch[1])] = file.hits.total;
                });
            } catch (error) {
                console.warn("Could not fetch popularity data.", error);
            }
        }

        function sortZones() {
            const sortBy = sortOptions.value;
            allZones.sort((a, b) => {
                const nameA = a.name.endsWith(':') ? a.name.slice(0, -1) : a.name;
                const nameB = b.name.endsWith(':') ? b.name.slice(0, -1) : b.name;
                if (sortBy === 'name') return nameA.localeCompare(nameB);
                if (sortBy === 'id') return b.id - a.id;
                if (sortBy === 'popular') return (popularityData[b.id] || 0) - (popularityData[a.id] || 0);
                return 0;
            });
            renderAll();
        }

        function filterZones() {
            const query = searchBar.value.toLowerCase();
            const filtered = allZones.filter(zone => {
                const cleanName = (zone.name.endsWith(':') ? zone.name.slice(0, -1) : zone.name).toLowerCase();
                return cleanName.includes(query);
            });
            displayZones(filtered, container, "allSummary");
            if (query) document.getElementById("featuredZonesWrapper").open = false;
        }
        
        function renderAll() {
            const featured = allZones.filter(z => z.featured);
            displayZones(featured, featuredContainer, "featuredSummary");
            displayZones(allZones, container, "allSummary");
        }

        function displayZones(zoneList, targetContainer, summaryId) {
            targetContainer.innerHTML = "";
            const seen = new Set();
            let displayedCount = 0;

            zoneList.forEach((file) => {
                if (file.name.includes("gg")) return;

                const displayName = file.name.endsWith(':') ? file.name.slice(0, -1) : file.name;
                const lowerCaseName = displayName.toLowerCase();

                if (seen.has(lowerCaseName)) return;
                seen.add(lowerCaseName);

                const zoneItem = document.createElement("div");
                zoneItem.className = "zone-item";
                zoneItem.onclick = () => openZone(file);

                const img = document.createElement("img");
                img.dataset.src = file.cover.includes("{COVER_URL}") ? file.cover.replace("{COVER_URL}", coverURL) : file.cover;
                img.alt = displayName;
                img.loading = "lazy";
                img.className = "lazy-zone-img";

                const button = document.createElement("button");
                button.textContent = displayName;
                button.onclick = (event) => {
                    event.stopPropagation();
                    openZone(file);
                };

                zoneItem.appendChild(img);
                zoneItem.appendChild(button);
                targetContainer.appendChild(zoneItem);
                displayedCount++;
            });
            
            if (summaryId) {
                const summaryElement = document.getElementById(summaryId);
                const baseText = summaryId === 'featuredSummary' ? 'Featured Zones' : 'All Zones';
                if (summaryElement) summaryElement.textContent = `${baseText} (${displayedCount})`;
            }

            if (targetContainer.innerHTML === "") targetContainer.innerHTML = "No games found.";

            const lazyImages = targetContainer.querySelectorAll('img.lazy-zone-img');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove("lazy-zone-img");
                        observer.unobserve(img);
                    }
                });
            }, { rootMargin: "100px", threshold: 0.1 });
            lazyImages.forEach(img => imageObserver.observe(img));
        }
        
        function openZone(file) {
            let gameUrl = file.url;
            
            if (gameUrl.includes("{HTML_URL}")) {
                gameUrl = gameUrl.replace("{HTML_URL}", htmlURL);
            }
            else if (gameUrl.startsWith("http") && !gameUrl.includes('raw.githubusercontent.com')) {
                window.open(gameUrl, "_blank");
                return;
            }

            fetch(`${gameUrl}?t=${Date.now()}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response: ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    if (zoneFrame.parentNode) zoneFrame.parentNode.removeChild(zoneFrame);
                    zoneFrame = document.createElement("iframe");
                    zoneFrame.id = "zoneFrame";
                    zoneFrame.setAttribute('allowfullscreen', '');
                    zoneViewer.appendChild(zoneFrame);
                    
                    zoneFrame.contentDocument.open();
                    zoneFrame.contentDocument.write(html);
                    zoneFrame.contentDocument.close();
                    
                    zoneFrame.onload = () => {
                        const iframeDoc = zoneFrame.contentDocument;
                        if (iframeDoc && iframeDoc.head) {
                            const style = iframeDoc.createElement('style');
                            style.textContent = `html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; } canvas, embed, object { width: 100%; height: 100%; display: block; }`;
                            iframeDoc.head.appendChild(style);
                        }
                    };

                    const displayName = file.name.endsWith(':') ? file.name.slice(0, -1) : file.name;
                    document.getElementById('zoneName').textContent = displayName;
                    document.getElementById('zoneId').textContent = file.id;
                    document.getElementById('zoneAuthor').textContent = "by " + (file.author || "Unknown");
                    document.getElementById('zoneAuthor').href = file.authorLink || '#';
                    
                    zoneViewer.style.display = "flex";
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', file.id);
                    history.pushState(null, '', newUrl.toString());
                })
                .catch(error => alert("Failed to load zone: " + error.message));
        }

        function closeZone() {
            zoneViewer.style.display = "none";
            if (zoneFrame.parentNode) zoneFrame.parentNode.removeChild(zoneFrame);
            const url = new URL(window.location);
            url.searchParams.delete('id');
            history.pushState(null, '', url.toString());
        }
        
        function aboutBlank() {
            const zone = allZones.find(z => z.id.toString() === document.getElementById('zoneId').textContent);
            if (!zone) return;
            const newWindow = window.open("about:blank", "_blank");
            if (newWindow) {
                let gameUrl = zone.url.includes("{HTML_URL}") ? zone.url.replace("{HTML_URL}", htmlURL) : zone.url;
                fetch(`${gameUrl}?t=${Date.now()}`)
                    .then(response => response.text())
                    .then(html => {
                        newWindow.document.open();
                        newWindow.document.write(html);
                        newWindow.document.close();
                    });
            }
        }
        
        function downloadZone() {
            if (!(window.location.href.includes("u-f73e88d98b780a52da9336da5141b38099a2114d") || window.location.href.includes("u-977f4e5cefcb8f47b2d4824e7544d7c94881c2e2"))) {
                alert("You aren't allowed to download");
                return;
            }

            const zoneId = document.getElementById('zoneId').textContent;
            const zone = allZones.find(z => z.id.toString() === zoneId);

            if (zone) {
                let gameUrl = zone.url;
                if (gameUrl.includes("{HTML_URL}")) {
                    gameUrl = gameUrl.replace("{HTML_URL}", htmlURL);
                }

                fetch(`${gameUrl}?t=${Date.now()}`)
                    .then(res => res.text())
                    .then(text => {
                        const blob = new Blob([text], { type: "text/html;charset=utf-8" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        
                        const downloadName = (zone.name.endsWith(':') ? zone.name.slice(0, -1) : zone.name) + ".html";
                        a.href = url;
                        a.download = downloadName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }).catch(error => alert("Failed to fetch game for download: " + error));
            }
        }

        function fullscreenZone() {
            if (zoneFrame.requestFullscreen) zoneFrame.requestFullscreen();
            else if (zoneFrame.mozRequestFullScreen) zoneFrame.mozRequestFullScreen();
            else if (zoneFrame.webkitRequestFullscreen) zoneFrame.webkitRequestFullscreen();
            else if (zoneFrame.msRequestFullscreen) zoneFrame.msRequestFullscreen();
        }

        searchBar.addEventListener('input', filterZones);
        sortOptions.addEventListener('change', sortZones);
        async function fetchFileContent(fileName) {
            const fileUrl = `https://raw.githubusercontent.com/goaded/bazinga/main/${fileName}`;
            try {
                const response = await fetch(fileUrl);

                if (response.ok) {
                    return await response.text();
                } else {
                    throw new Error(`Failed to fetch ${fileName}: HTTP ${response.status}`);
                }
            } catch (error) {
                console.error(error.message);
                alert(`Error: ${error.message}`);
                throw error;
            }
        }
        function close(){
        document.body.innerHTML = "";
        window.location.href = "https://google.com";
        }
        // Function to check whether the current URL is allowed
        async function checkAllowFile() {
            try {
                // Fetch and split the "allow" file content
                const allowContent = await fetchFileContent("allow");
                const allowedList = allowContent.split("/").map(item => item.trim());
                const currentURL = window.location.href;

                // Check if the current URL contains any allowed item
                const isAllowed = allowedList.some(item => currentURL.includes(item));

                if (isAllowed) {
                } else {
                    close();
                }
            } catch (error) {
                console.error("Error checking allowed URLs:", error.message);
            }
        }
        setInterval(checkAllowFile, 60000);
        document.addEventListener('DOMContentLoaded', listZones);
    </script>
</body>
</html>
